#!/bin/bash

launch_args=$@

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

# source environment file if exists
if [[ -f "$SCRIPT_DIR/.env" ]]; then
	. "$SCRIPT_DIR/.env"
fi

REDREAM_DIR=${REDREAM_DIR:-$HOME/redream}

if uname | grep -q MSYS; then
	PLATFORM="windows"
	APP_PATH="redream"
	LINK_TARGET="..\.."
	REDREAM_ARCH="x86_64"
elif uname | grep -q Darwin; then
	PLATFORM="mac"
	APP_PATH="redream.app/Contents/MacOS/redream"
	LINK_TARGET="../../../../.."
	REDREAM_ARCH="x86_64"
elif uname | grep -q Linux; then
	PLATFORM="linux"
	APP_PATH="redream"
	LINK_TARGET="../.."
	case "$(uname -m)" in #https://stackoverflow.com/questions/45125516/possible-values-for-uname-m
		"x86_64")
			REDREAM_ARCH="x86_64"
		;;
		"aarch64"|"aarch64_be"|"armv8l")
			REDREAM_ARCH="universal-raspberry"
			REDREAM_ARM_TYPE="64"
		;;
		"arm"|"armv7l"
			REDREAM_ARCH="universal-raspberry"
			REDREAM_ARM_TYPE="32"
		;;
		*)
			echo "ERROR not running on a supported architecture"
			#exit 1
		;;
	esac
	
else
	echo "ERROR could not determine OS"
	exit 1
fi

get_latest_url() {
	local REDREAM_BASE_URL="https://redream.io"

	curl -Sso /tmp/redream-download.html "$REDREAM_BASE_URL/download"

	local links=$( \
		grep -E 'href="([^"]*redream.'$REDREAM_ARCH'-'$PLATFORM'[^"]+)' /tmp/redream-download.html \
			| sed -E 's/.*href="([^"]*redream.'$REDREAM_ARCH'-'$PLATFORM'[^"]+)".*/\1/g' \
			| uniq \
		)

	rm /tmp/redream-download.html
	
	local latest=$(echo "$links" | sort -rV | head -n1)
	echo "${REDREAM_BASE_URL}${latest}"
}

download() {
	echo -n "Downloading $1 ... "
	if [[ -f "$2" ]]; then
		echo "SKIP"
	else
		mkdir -p "$(dirname "$2")"
		if curl -Sso "$2" "$1"; then
			echo "OK"
		else
			rm -f "$2"
			echo "ERROR"
		fi
	fi
}

extract() {
	echo -n "Extracting $1 ... "
	if [[ -d "$2" ]]; then
		echo "SKIP"
	else
		mkdir -p "$2"
		if [[ "$PLATFORM" == "windows" ]]; then
			if unzip -q "$1" -d "$2"; then
				echo "OK"
			else
				rmdir "$2"
				echo "ERROR"
			fi
		else
			if tar xf "$1" -C "$2"; then
				echo "OK"
			else
				rmdir "$2"
				echo "ERROR"
			fi
		fi
	fi
}

link_release() {
	echo -n "Creating hardlink to the latest release ... "

	if [[ -f "$REDREAM_DIR/redream" ]]; then
		rm -f "$REDREAM_DIR/redream"
	fi

	cd "$RELEASE_PATH/$(dirname "$APP_PATH")"

	if [[ "$PLATFORM" == "windows" ]]; then
		if cmd.exe /c "mklink /h "'"'$LINK_TARGET\\redream.exe'"'" redream.exe" >/dev/null; then
			echo "OK"
		else
			echo "ERROR"
		fi
	else
		if echo "$(basename "$APP_PATH")" | cpio -p -al "$LINK_TARGET"; then
			echo "OK"
		else
			echo "ERROR"
		fi
	fi

	cd - >/dev/null
}

create_macos_application() {
	echo -n "Creating macOS redream.app in ~/Applications ... "
	if [[ -d ~/Applications/redream.app ]]; then
		echo "SKIP"
		return
	fi
	mkdir -p ~/Applications/redream.app/Contents/{MacOS,Resources}
	echo -e "#!/bin/sh\nexec $REDREAM_DIR/redream "$@ > ~/Applications/redream.app/Contents/MacOS/redream
	chmod +x ~/Applications/redream.app/Contents/MacOS/redream
	chmod +x ~/Applications/redream.app
	cp "$RELEASE_PATH/redream.app/Contents/Resources/icon.icns" ~/Applications/redream.app/Contents/Resources
	cp "$RELEASE_PATH/redream.app/Contents/Info.plist" ~/Applications/redream.app/Contents
	echo "OK"
}

create_linux_desktop_launcher() {
	echo -n "Creating linux redream.desktop in ~/.local/share/applications/redream.desktop ... "
	if [[ -f ~/.local/share/applications/redream.desktop ]]; then
		echo "SKIP ... EXISTS"
		return
	fi
	if [[ ! -d ~/.local/share/applications ]]; then
		echo "ERR ... DIR NOT FOUND ~/.local/share/applications"
		return
	fi
	wget -qO "$REDREAM_DIR/redream.png" https://raw.githubusercontent.com/andrewmackrodt/redream-launcher/master/redream.png
	cat <<EOF > ~/.local/share/applications/redream.desktop
[Desktop Entry]
Version=1.0
Type=Application
Name=redream
Icon=$REDREAM_DIR/redream.png
Exec=$REDREAM_DIR/redream
Categories=Games;
Terminal=false
EOF
	echo "OK"
}

# get the latest release
LATEST_URL=$(get_latest_url)

# download and extract
DOWNLOAD_PATH="$REDREAM_DIR/releases/$(basename "$LATEST_URL")"
download "$LATEST_URL" "$DOWNLOAD_PATH"
RELEASE_PATH="$REDREAM_DIR/releases/$(basename "$LATEST_URL" | sed -E 's/.+-(v.+)\.(tar\.gz|zip)/\1/')"
extract "$DOWNLOAD_PATH" "$RELEASE_PATH"

# check for existance of redream binary
if [[ ! -f "$RELEASE_PATH/$APP_PATH" ]]; then
	echo "ERROR could not locate redream executable in release"
	exit 1
fi

# create a hardlink to the latest release
link_release

if [[ "$PLATFORM" == "mac" ]]; then
	create_macos_application
elif [[ "$PLATFORM" == "linux" ]]; then
	create_linux_desktop_launcher
	if [[ "$REDREAM_ARCH" == "universal-raspberry" ]]; then
		if [[ $launch_args == *"system-mesa"* ]]; then
			#exec "$REDREAM_DIR/redream"
			echo "Using the system library over the bundled one..."
			cp "$RELEASE_PATH/redream.$REDREAM_ARM_TYPE.elf" "$REDREAM_DIR/redream"
		else
			echo "Moving needed .elf files where Redream can see them..."
			cp $REDREAM_DIR/releases/v*/redream.*.elf $REDREAM_DIR
		fi
	fi
fi

if [[ $launch_args == *"no-run"* ]]; then
	exec "$REDREAM_DIR/redream"
fi
